---
import { getRelativeLocaleUrl } from "astro:i18n";
import { useTranslations, type Language } from "../../utils/i18n";
import { localizedUrl } from "../../utils/url";
import ThemeToggle from "./ThemeToggle.astro";
import LanguageSwitcher from "./LanguageSwitcher.astro";

// Use Astro's built-in locale detection
const lang = (Astro.currentLocale || "en") as Language;
const t = useTranslations(lang);

const navItems = [
  { href: localizedUrl(lang, "/"), label: t("nav.home") },
  { href: localizedUrl(lang, "/projects"), label: t("nav.projects") },
  { href: localizedUrl(lang, "/#about"), label: t("nav.about") },
  { href: localizedUrl(lang, "/#contact"), label: t("nav.contact") },
];
---

<header
  class="sticky top-0 z-50 w-full glass border-b border-light-border/50 dark:border-dark-border/50"
>
  <nav class="container-custom py-4">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a
        href={localizedUrl(lang, "/")}
        class="text-xl font-bold text-light-text dark:text-dark-text hover:text-primary-600 dark:hover:text-primary-400 transition-colors group"
      >
        <span class="inline-flex items-center gap-2">
          <span
            class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary-600 to-accent-600 flex items-center justify-center text-white font-bold text-lg group-hover:scale-110 transition-transform"
          >
            DB
          </span>
          <span class="hidden sm:inline">Dmitry Beresnev</span>
        </span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        <ul class="flex items-center gap-6">
          {
            navItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  class="text-sm font-medium text-light-text-muted dark:text-dark-text-muted hover:text-primary-600 dark:hover:text-primary-400 transition-colors relative group"
                >
                  {item.label}
                  <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-primary-600 transition-all group-hover:w-full" />
                </a>
              </li>
            ))
          }
        </ul>

        <!-- Theme & Language -->
        <div class="flex items-center gap-3">
          <ThemeToggle />
          <LanguageSwitcher />
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <div class="flex md:hidden items-center gap-3">
        <ThemeToggle />
        <LanguageSwitcher />
        <button
          id="mobile-menu-button"
          class="p-2 text-light-text dark:text-dark-text hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
          aria-label="Toggle menu"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="hidden md:hidden mt-4 pt-4 border-t border-light-border dark:border-dark-border"
    >
      <ul class="flex flex-col gap-4">
        {
          navItems.map((item) => (
            <li>
              <a
                href={item.href}
                class="block text-sm font-medium text-light-text-muted dark:text-dark-text-muted hover:text-primary-600 dark:hover:text-primary-400 transition-colors py-2"
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </nav>
</header>

<script>
  function setupMobileMenu() {
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");

    if (!menuButton || !mobileMenu) return;

    // Toggle menu
    const toggleMenu = () => {
      mobileMenu.classList.toggle("hidden");
    };

    // Close menu when clicking outside
    const closeMenuOutside = (e: Event) => {
      if (
        !menuButton.contains(e.target as Node) &&
        !mobileMenu.contains(e.target as Node)
      ) {
        mobileMenu.classList.add("hidden");
      }
    };

    // Close menu when clicking a link
    const closeMenuOnLink = () => {
      mobileMenu.classList.add("hidden");
    };

    // Remove old listeners
    menuButton.removeEventListener("click", toggleMenu);
    document.removeEventListener("click", closeMenuOutside);

    // Add new listeners
    menuButton.addEventListener("click", toggleMenu);
    document.addEventListener("click", closeMenuOutside);

    // Close menu when clicking a link
    mobileMenu.querySelectorAll("a").forEach((link) => {
      link.removeEventListener("click", closeMenuOnLink);
      link.addEventListener("click", closeMenuOnLink);
    });
  }

  // Setup on page load
  setupMobileMenu();

  // Re-setup after ClientRouter navigation
  document.addEventListener("astro:page-load", setupMobileMenu);
</script>
